-- ============================================================================
-- SECURITY FIX: ุชุฃููู ูุธุงู ุงูุชุณุฌูู ูุฅุบูุงู ุงูุซุบุฑุงุช ุงูุฃูููุฉ
-- ============================================================================
-- 
-- ุงููุดููุฉ ุงููุฏููุฉ:
-- - ูุงู ุงููุณุชุฎุฏู ูุณุชุทูุน ุงูุชูุงุนุจ ุจู role ู status ูู ุงููุชุตูุญ
-- - ุงูุณูุงุณุงุช ูุงูุช ููุชูุญุฉ ููุฌููุน (Enable insert for everyone)
--
-- ุงูุญู ุงูุฌุฏูุฏ:
-- - ุงุณุชุฎุฏุงู Database Trigger ูุฅูุดุงุก ุงูุณุฌู ุชููุงุฆูุงู
-- - ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ุชุญุฏุฏ role='member' ู status='pending'
-- - ุณูุงุณุงุช RLS ุตุงุฑูุฉ (ุงูุฃุฏูู ููุท ูุฑู ุงูููุ ุงูุนุถู ูุฑู ููุณู ููุท)
-- ============================================================================

-- 1๏ธโฃ ุชูุธูู ุงูุณูุงุณุงุช ุงููุฏููุฉ ุงูููุชูุญุฉ (ุฅุบูุงู ุงูุซุบุฑุงุช)
-- ----------------------------------------------------------------------------
DROP POLICY IF EXISTS "Enable insert for everyone" ON public.members;
DROP POLICY IF EXISTS "Enable select for everyone" ON public.members;
DROP POLICY IF EXISTS "Allow public signup" ON public.members;

COMMENT ON TABLE public.members IS 'ุฌุฏูู ุงูุฃุนุถุงุก - ูุญูู ุจู RLS ู Triggers';

-- 2๏ธโฃ ุฅูุดุงุก ุฏุงูุฉ ููุณุฎ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ ุชููุงุฆูุงู
-- ----------------------------------------------------------------------------
-- ูุฐู ุงูุฏุงูุฉ ุชุนูู ุชููุงุฆูุงู ุนูุฏ ูู ุชุณุฌูู ุฌุฏูุฏ ูู auth.users
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER 
LANGUAGE plpgsql 
SECURITY DEFINER -- ุชุนูู ุจุตูุงุญูุงุช ุนุงููุฉ (ุขููุฉ ูุฃููุง server-side)
SET search_path = public
AS $$
BEGIN
  -- ุฅุถุงูุฉ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ ูุฌุฏูู members ุชููุงุฆูุงู
  INSERT INTO public.members (
    id,           -- ููุณ ID ูู auth.users
    email,        -- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
    name,         -- ุงูุงุณู ูู metadata
    phone,        -- ุฑูู ุงููุงุชู ูู metadata
    reason,       -- ุณุจุจ ุงูุงูุถูุงู ูู metadata
    role,         -- ๐ ุฏุงุฆูุงู 'member' (ูุง ูููู ุงูุชูุงุนุจ ุจู)
    status        -- ๐ ุฏุงุฆูุงู 'pending' (ูุง ูููู ุงูุชูุงุนุจ ุจู)
  )
  VALUES (
    NEW.id, 
    NEW.email, 
    COALESCE(NEW.raw_user_meta_data->>'full_name', 'ูุณุชุฎุฏู ุฌุฏูุฏ'),
    NEW.raw_user_meta_data->>'phone',
    NEW.raw_user_meta_data->>'reason',
    'member',     -- ๐ ุงูุฑุชุจุฉ ุงูุงูุชุฑุงุถูุฉ ุฏุงุฆูุงู ุนุถู (ุฃูุงู)
    'pending'     -- ๐ ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ ุฏุงุฆูุงู ูุนูู (ุชูุชุธุฑ ููุงููุฉ ุงูุฃุฏูู)
  );
  
  RETURN NEW;
EXCEPTION
  WHEN OTHERS THEN
    -- ุชุณุฌูู ุงูุฎุทุฃ ููู ูุง ุชููู ุนูููุฉ ุงูุชุณุฌูู
    RAISE WARNING 'Failed to create member record: %', SQLERRM;
    RETURN NEW;
END;
$$;

COMMENT ON FUNCTION public.handle_new_user IS 'ุชูุดุฃ ุณุฌู ุนุถู ุชููุงุฆูุงู ุนูุฏ ุงูุชุณุฌูู - ุขููุฉ ูู ุงูุชูุงุนุจ';

-- 3๏ธโฃ ุชุดุบูู ุงูุฏุงูุฉ ุชููุงุฆูุงู ุนูุฏ ูู ุชุณุฌูู ุฌุฏูุฏ
-- ----------------------------------------------------------------------------
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW 
  EXECUTE FUNCTION public.handle_new_user();

COMMENT ON TRIGGER on_auth_user_created ON auth.users IS 'ููุดุฆ ุณุฌู ูู members ุชููุงุฆูุงู ุนูุฏ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ';

-- 4๏ธโฃ ูุถุน ุณูุงุณุงุช RLS ุฃูููุฉ ุตุงุฑูุฉ
-- ----------------------------------------------------------------------------

-- ๐ ุณูุงุณุฉ ุงููุฑุงุกุฉ (SELECT):
-- - ุงูุฃุฏูู ูุฑู ูู ุงูุฃุนุถุงุก
-- - ุงูุนุถู ุงูุนุงุฏู ูุฑู ููุณู ููุท
CREATE POLICY "Admins see all, Users see self" 
ON public.members
FOR SELECT 
USING (
  -- ุงููุณุชุฎุฏู ุงูุญุงูู ูู ุตุงุญุจ ุงูุณุฌู
  auth.uid() = id 
  OR 
  -- ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ุฃุฏูู
  EXISTS (
    SELECT 1 
    FROM public.members 
    WHERE id = auth.uid() 
      AND role = 'admin'
  )
);

-- ๐ ุณูุงุณุฉ ุงูุชุนุฏูู (UPDATE):
-- - ุงูุฃุฏูู ููุท ูุณุชุทูุน ุชุนุฏูู ุงูุญุงูุงุช ูุงูุฑุชุจ (ูุจูู/ุฑูุถ ุงูุฃุนุถุงุก)
CREATE POLICY "Only Admins can update members" 
ON public.members
FOR UPDATE 
USING (
  EXISTS (
    SELECT 1 
    FROM public.members 
    WHERE id = auth.uid() 
      AND role = 'admin'
  )
);

-- ๐ ุณูุงุณุฉ ุงูุญุฐู (DELETE):
-- - ุงูุฃุฏูู ููุท ูุณุชุทูุน ุญุฐู ุงูุฃุนุถุงุก
CREATE POLICY "Only Admins can delete members" 
ON public.members
FOR DELETE 
USING (
  EXISTS (
    SELECT 1 
    FROM public.members 
    WHERE id = auth.uid() 
      AND role = 'admin'
  )
);

-- ๐ซ ููุน ุงูุฅุถุงูุฉ ุงููุจุงุดุฑุฉ ูู ุงูู Client
-- ูุง ูุญุชุงุฌ ุณูุงุณุฉ INSERT ูุฃู ุงูุฅุถุงูุฉ ุชุชู ููุท ุนุจุฑ ุงูู Trigger
-- (ุฃู ูุญุงููุฉ ููุฅุถุงูุฉ ูู ุงููุชุตูุญ ุณุชุฑูุถ ุชููุงุฆูุงู)

-- 5๏ธโฃ ุชูุนูู Row Level Security
-- ----------------------------------------------------------------------------
ALTER TABLE public.members ENABLE ROW LEVEL SECURITY;

-- 6๏ธโฃ ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช
-- ----------------------------------------------------------------------------
-- ุนุฑุถ ุงูุณูุงุณุงุช ุงูุญุงููุฉ
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies 
WHERE tablename = 'members';

-- ============================================================================
-- โ ุชู ุชุทุจูู ุงูุญู ุงูุฃููู!
-- ============================================================================
-- 
-- ุงูุขู:
-- โ ุงููุณุชุฎุฏู ูุง ูุณุชุทูุน ุงูุชูุงุนุจ ุจู role ุฃู status
-- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ูู ุชุญุฏุฏ ุงูููู ุงูุงูุชุฑุงุถูุฉ
-- โ ุงูุฃุฏูู ููุท ูุฑู ูู ุงูุฃุนุถุงุก
-- โ ุงูุนุถู ุงูุนุงุฏู ูุฑู ููุณู ููุท
-- โ ุงูุฃุฏูู ููุท ูุณุชุทูุน ูุจูู/ุฑูุถ ุงูุทูุจุงุช
-- โ ูุง ูููู ุงูุฅุถุงูุฉ ุงููุจุงุดุฑุฉ ูู ุงููุชุตูุญ
-- 
-- ููุงุฎุชุจุงุฑ:
-- 1. ุณุฌู ูุณุชุฎุฏู ุฌุฏูุฏ ูู ุงููููุน
-- 2. ุงูุญุต ุฌุฏูู members - ูุฌุจ ุฃู ุชุฌุฏ ุงูุณุฌู ุจู status='pending' ู role='member'
-- 3. ุญุงูู ุชุณุฌูู ุฏุฎูู ุจุงูุญุณุงุจ ุงูุฌุฏูุฏ - ูุฌุจ ุฃู ูุธูุฑ "ุทูุจู ููุฏ ุงููุฑุงุฌุนุฉ"
-- 4. ุณุฌู ุฏุฎูู ูุฃุฏูู ููู ุจุชุบููุฑ status ุฅูู 'active'
-- 5. ุงูุขู ุงููุณุชุฎุฏู ูุณุชุทูุน ุงูุฏุฎูู
-- ============================================================================
